<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GNSS RTK Station</title>
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="favicon.ico" rel="icon">
    <script src="jquery-3.7.0.min.js"></script>
    <style>
        .card-title {
            font-weight: bold;
            margin-bottom: unset;
        }

        .input-label {
            min-width: 13ch;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            background-color: white;
            display: none;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-3 mb-5">
        <form class="needs-validation" id="form" novalidate>
            <div class="row">
                <div class="col-xl-6">

                    <div class="card mb-3">
                        <div class="card-header">
                            <div>
                                <span class="d-inline-block card-title">GNSS Position</span>
                                <span class="d-inline-block float-end" id="gnss_status">Unknown</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Latitude</span>
                                <input type="text" class="form-control" id="gnss_lat" value="" disabled>
                            </div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Longitude</span>
                                <input type="text" class="form-control" id="gnss_lon" value="" disabled>
                            </div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Altitude<sub>(ASL)</sub></span>
                                <input type="text" class="form-control" id="gnss_alt" value="" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <div>
                                <span class="d-inline-block card-title">WiFi Network</span>
                                <span class="d-inline-block float-end" id="wifi_status">Disconnected</span>
                            </div>
                            <div class="small">May need to reconect to device</div>
                        </div>
                        <div class="card-body">
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">SSID</span>
                                <input type="text" class="form-control" id="wifi_ssid" value="" required>
                            </div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Password</span>
                                <input type="text" class="form-control" id="wifi_pwd" value="" required>
                            </div>
                            <div class="input-group mb-3"></div>
                            <div class="input-group mb-1">
                                <button class="btn btn-outline-primary mx-auto w-50" type="button" id="wifi_connect">Connect</button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <div>
                                <span class="d-inline-block card-title">System Settings</span>
                                <span class="d-inline-block float-end" id="system_version">&nbsp;</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-3 mb-1">
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" id="system_status_enable" checked>
                                        <label class="form-check-label" for="system_status_enable">Status</label>
                                    </div>
                                </div>
                                <div class="col-3 mb-1">

                                </div>
                                <div class="col-3 mb-1 d-flex">
                                    <button class="btn btn-sm btn-outline-danger flex-fill" type="button" id="system_restart">
                                        Restart
                                    </button>
                                </div>
                                <div class="col-3 mb-1 d-flex">
                                    <button class="btn btn-sm btn-outline-danger flex-fill" type="button" id="system_advanced">
                                        Advanced
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    </div>

    <div class="overlay align-items-center justify-content-center" id="overlay">
        <span id="overlay_message"></span>
    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            console.log("Document is ready!");

            const newline = "\n";
            let form = $("#form");
            let overlay = $("#overlay");
            let overlay_message = overlay.find("#overlay_message");

            function overlay_show(msg) {
                overlay_message.text(msg);
                overlay.addClass("d-flex");
            }

            function overlay_dismiss() {
                overlay.removeClass("d-flex");
            }

            // GNSS Position
            let gnss_status = form.find("#gnss_status");
            let gnss_lat = form.find("#gnss_lat");
            let gnss_lon = form.find("#gnss_lon");
            let gnss_alt = form.find("#gnss_alt");

            // WiFi settings
            let wifi_status = form.find("#wifi_status");
            let wifi_ssid = form.find("#wifi_ssid");
            let wifi_pwd = form.find("#wifi_pwd");
            let wifi_connect = form.find("#wifi_connect");
            wifi_connect.click(function () {
                if (confirm("Connect to a WiFi network?\nReconnect to device after few minutes!")) {
                    $.ajax({
                        url: "/status",
                        type: "POST",
                        contentType: "text/plain",
                        data: "wifi_connect" + newline +
                            wifi_ssid.val() + newline +
                            wifi_pwd.val()
                    });
                }
            });

            // Get status
            const STATUS = {
                GNSS_STATUS: 0,
                WIFI_STATUS: 1,
            }

            function nmea2dec(nmea, dir) {
                let dot = nmea.indexOf(".");
                let dd = 0;
                let mm = 0.0;

                if (dot > 2) {
                    dd = parseInt(nmea.substring(0, dot - 2));
                    mm = parseFloat(nmea.substring(dot - 2));
                }
                else {
                    mm = parseFloat(nmea);
                }

                let dec = dd + mm / 60;

                if (dir == 'N' || dir == 'E')
                    return dec;
                else
                    return -dec;

            }

            function isIP(text) {
                let parts = text.split(".");
                console.log(parts);
                return parts.length == 4;
            }

            function query_status() {
                $.ajax({
                    url: "/status",
                    type: "GET",
                    contentType: "text/plain",
                    success: function (response, status) {
                        let data = response.split(newline);
                        // ordered items

                        // GNSS Status
                        let gnss_gga = data[STATUS.GNSS_STATUS].split(",");

                        let gnss_status_val = parseInt(gnss_gga[6]);
                        switch (gnss_status_val) {
                            case 0:
                                gnss_status.text("No Fix");
                                break;
                            case 1:
                                gnss_status.text("Single");
                                break;
                            case 2:
                                gnss_status.text("Float");
                                break;
                            case 4:
                                gnss_status.text("RTK Fix");
                                break;
                            case 5:
                                gnss_status.text("RTK Float");
                                break;
                            default:
                                gnss_status.text("Unknown");
                                break;
                        }

                        let gnss_lat_val = nmea2dec(gnss_gga[2], gnss_gga[3]);
                        gnss_lat.val(gnss_lat_val.toFixed(9));

                        let gnss_lon_val = nmea2dec(gnss_gga[4], gnss_gga[5]);
                        gnss_lon.val(gnss_lon_val.toFixed(9));

                        let gnss_alt_val = parseFloat(gnss_gga[9]);
                        gnss_alt.val(gnss_alt_val.toFixed(3));

                        // WIFI Status
                        let wifi_status_val = data[STATUS.WIFI_STATUS];
                        wifi_status.text(wifi_status_val);
                    }
                });
            }

            let query_status_timer = setInterval(query_status, 1000);

            // System Settings
            let system_status_enable = form.find("#system_status_enable");
            system_status_enable.change(function () {
                if (this.checked) {
                    query_status_timer = setInterval(query_status, 1000);
                } else {
                    clearInterval(query_status_timer);
                }
            });

            let system_restart = form.find("#system_restart");
            system_restart.click(function () {
                if (confirm("Do you want to Restart device?")) {
                    $.ajax({
                        url: "/status",
                        type: "POST",
                        contentType: "text/plain",
                        data: "restart"
                    });
                }
            });

            // Load configs
            $.ajax({
                url: "/config",
                type: "GET",
                contentType: "text/plain",
                success: function (response, status) {
                    let data = response.split(newline);
                    // ordered items
                    wifi_ssid.val(data[0]);
                    wifi_pwd.val(data[1]);
                }
            });
        });
    </script>
</body>

</html>