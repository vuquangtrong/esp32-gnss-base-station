<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GNSS RTK Station</title>
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="favicon.ico" rel="icon">
    <script src="jquery-3.7.0.min.js"></script>
    <style>
        .card-title {
            font-weight: bold;
            margin-bottom: unset;
        }

        .input-label {
            min-width: 13ch;
        }

        .input-unit {
            min-width: 7ch;
        }

        .nav-tabs .nav-link {
            color: var(--bs-dark);
        }

        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
        }

        .tab-content {
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            border-radius: 0px 0px var(--bs-border-radius) var(--bs-border-radius);
            padding: .75rem;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            background-color: white;
            display: none;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-3">
        <form class="needs-validation" id="form" novalidate>
            <div class="row">
                <div class="col-xl-6">

                    <div class="card mb-3">
                        <div class="card-header">
                            <div>
                                <span class="d-inline-block card-title">GNSS Position</span>
                                <span class="d-inline-block float-end" id="gnss_status">Unknown</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Latitude</span>
                                <input type="number" class="form-control" id="gnss_lat" value="" disabled>
                            </div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Longitude</span>
                                <input type="number" class="form-control" id="gnss_lon" value="" disabled>
                            </div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Altitude<sub>(ASL)</sub></span>
                                <input type="number" class="form-control" id="gnss_alt" value="" disabled>
                                <span class="input-group-text input-unit">m</span>
                            </div>
                            <div class="mb-3"></div>
                            <div class="mb-1">Option:</div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Mode</span>
                                <input type="text" class="form-control" id="gnss_mode" value="" disabled>
                            </div>
                            <div class="mb-1">
                                <ul class="nav nav-tabs nav-fill" id="gnss_tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="gnss_tab_rover" data-bs-toggle="tab" data-bs-target="#gnss_pane_rover" type="button" role="tab">Rover</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="gnss_tab_base" data-bs-toggle="tab" data-bs-target="#gnss_pane_base" type="button" role="tab">Base</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="gnss_panes">
                                    <div class="tab-pane fade show active" id="gnss_pane_rover" role="tabpanel" tabindex="0">
                                        <div>
                                            <div class="input-group input-group-sm mb-1">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="" id="ntrip_cli_enable">
                                                    <label class="form-check-label" for="ntrip_cli_enable">Use NTRIP Client to get correction</label>
                                                </div>
                                            </div>
                                            <div class="mb-3"></div>
                                            <div class="d-none" id="ntrip_cli_panel">
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">IP/Host</span>
                                                    <input type="text" class="form-control" id="ntrip_cli_ip" value="">
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Port</span>
                                                    <input type="number" class="form-control" id="ntrip_cli_port" value="">
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Username</span>
                                                    <input type="text" class="form-control" id="ntrip_cli_user" value="">
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Password</span>
                                                    <input type="text" class="form-control" id="ntrip_cli_pwd" value="">
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Mount</span>
                                                    <select class="form-select" id="ntrip_cli_mnt"></select>
                                                </div>
                                                <div class="mb-3"></div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <button class="btn btn-sm btn-outline-primary flex-fill" type="button" id="ntrip_cli_get_mnts">Get Mounts</button>
                                                    <button class="btn btn-sm btn-outline-primary flex-fill" type="button" id="ntrip_cli_connect">Connect</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3"></div>
                                        <div class="input-group mb-1">
                                            <button class="btn btn-sm btn-outline-primary mx-auto w-50" type="button" id="gnss_mode_set_rover">Start Rover</button>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="gnss_pane_base" role="tabpanel" tabindex="0">
                                        <div>
                                            <div class="input-group input-group-sm mb-1">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="" id="gnss_base_fixed_enable">
                                                    <label class="form-check-label" for="gnss_base_fixed_enable">Set Base's position manually</label>
                                                </div>
                                            </div>
                                            <div class="mb-3"></div>
                                            <div id="gnss_pane_survey">
                                                <div class="small mb-1">Survey-in Option:</div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Duration</span>
                                                    <input type="number" class="form-control" id="gnss_survey_dur" value="5">
                                                    <span class="input-group-text input-unit">mins</span>
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Accuracy</span>
                                                    <input type="number" class="form-control" id="gnss_survey_acc" value="100">
                                                    <span class="input-group-text input-unit">mm</span>
                                                </div>

                                                <div class="mb-3"></div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <button class="btn btn-sm btn-outline-primary mx-auto w-50" type="button" id="gnss_mode_set_survey">Start Survey Base</button>
                                                </div>
                                            </div>
                                            <div class="d-none" id="gnss_pane_fixed">
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Latitude</span>
                                                    <input type="number" class="form-control" id="gnss_fixed_lat" value="">
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Longitude</span>
                                                    <input type="number" class="form-control" id="gnss_fixed_lon" value="">
                                                </div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <span class="input-group-text input-label">Altitude<sub>(ASL)</sub></span>
                                                    <input type="number" class="form-control" id="gnss_fixed_alt" value="">
                                                    <span class="input-group-text input-unit">m</span>
                                                </div>
                                                <div class="mb-3"></div>
                                                <div class="input-group input-group-sm mb-1">
                                                    <button class="btn btn-sm btn-outline-primary mx-auto w-50" type="button" id="gnss_mode_set_fixed">Start Fixed Base</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <div>
                                <span class="d-inline-block card-title">WiFi Network</span>
                                <span class="d-inline-block float-end" id="wifi_status">Disconnected</span>
                            </div>
                            <div class="small">May need to reconect to device</div>
                        </div>
                        <div class="card-body">
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">SSID</span>
                                <input type="text" class="form-control" id="wifi_ssid" value="" required>
                            </div>
                            <div class="input-group mb-1">
                                <span class="input-group-text input-label">Password</span>
                                <input type="text" class="form-control" id="wifi_pwd" value="" required>
                            </div>
                            <div class="mb-3"></div>
                            <div class="input-group mb-1">
                                <button class="btn btn-sm btn-outline-primary mx-auto w-50" type="button" id="wifi_connect">Connect</button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <div>
                                <span class="d-inline-block card-title">System Settings</span>
                                <span class="d-inline-block float-end" id="system_version">&nbsp;</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="mb-1">Address of device in the local network:</div>
                                <div class="input-group mb-1">
                                    <span class="input-group-text input-label">http://</span>
                                    <span class="input-group-text flex-fill" id="system_hostname"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" id="system_status_enable" checked>
                                        <label class="form-check-label" for="system_status_enable">Update status from device</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col d-flex">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" type="button" id="system_save">Save</button>
                                </div>
                                <div class="col d-flex">
                                    <button class="btn btn-sm btn-outline-danger flex-fill" type="button" id="system_restart">Restart</button>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col mb-3">
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" id="system_advanced_enable">
                                        <label class="form-check-label" for="system_advanced_enable">Advanced</label>
                                    </div>
                                </div>
                                <div class="col-12 d-none" id="system_advanced_pane">
                                    <div class="row mb-3">
                                        <div class="col d-flex">
                                            <button class="btn btn-sm btn-outline-primary flex-fill" type="button" id="system_clear_settings">Clear Settings</button>
                                        </div>
                                        <div class="col d-flex">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    </div>

    <div class="overlay align-items-center justify-content-center" id="overlay">
        <span id="overlay_message"></span>
    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            console.log("Document is ready!");

            const newline = "\n";
            let form = $("#form");
            let overlay = $("#overlay");
            let overlay_message = overlay.find("#overlay_message");

            function overlay_show(msg) {
                overlay.addClass("d-flex");
                overlay_message.text(msg);
            }

            function overlay_dismiss() {
                overlay.removeClass("d-flex");
            }

            // GNSS Position
            let gnss_status = form.find("#gnss_status");
            let gnss_lat = form.find("#gnss_lat");
            let gnss_lon = form.find("#gnss_lon");
            let gnss_alt = form.find("#gnss_alt");

            // GNSS Mode
            let gnss_mode = form.find("#gnss_mode");

            let ntrip_cli_enable = form.find("#ntrip_cli_enable");
            let ntrip_cli_panel = form.find("#ntrip_cli_panel");
            let ntrip_cli_ip = form.find("#ntrip_cli_ip");
            let ntrip_cli_port = form.find("#ntrip_cli_port");
            let ntrip_cli_user = form.find("#ntrip_cli_user");
            let ntrip_cli_pwd = form.find("#ntrip_cli_pwd");
            let ntrip_cli_mnt = form.find("#ntrip_cli_mnt");
            let ntrip_cli_get_mnts = form.find("#ntrip_cli_get_mnts");
            let ntrip_cli_connect = form.find("#ntrip_cli_connect");

            let gnss_mode_set_rover = form.find("#gnss_mode_set_rover");

            let gnss_base_fixed_enable = form.find("#gnss_base_fixed_enable");

            let gnss_pane_survey = form.find("#gnss_pane_survey");
            let gnss_survey_dur = form.find("#gnss_survey_dur");
            let gnss_survey_acc = form.find("#gnss_survey_acc");
            let gnss_mode_set_survey = form.find("#gnss_mode_set_survey");

            let gnss_pane_fixed = form.find("#gnss_pane_fixed");
            let gnss_fixed_lat = form.find("#gnss_fixed_lat");
            let gnss_fixed_lon = form.find("#gnss_fixed_lon");
            let gnss_fixed_alt = form.find("#gnss_fixed_alt");
            let gnss_mode_set_fixed = form.find("#gnss_mode_set_fixed");

            ntrip_cli_enable.click(function () {
                if (this.checked) {
                    ntrip_cli_panel.removeClass("d-none");
                } else {
                    ntrip_cli_panel.addClass("d-none");
                }
            })

            ntrip_cli_get_mnts.click(function () {
                $.ajax({
                    url: "/action",
                    type: "POST",
                    contentType: "text/plain",
                    data: "ntrip_cli_get_mnts" + newline +
                        ntrip_cli_ip.val() + newline +
                        ntrip_cli_port.val() + newline +
                        ntrip_cli_user.val() + newline +
                        ntrip_cli_pwd.val() + newline
                });
            });

            ntrip_cli_connect.click(function () {
                if (confirm("Connect to NTRIP Caster?")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "ntrip_cli_connect" + newline +
                            ntrip_cli_ip.val() + newline +
                            ntrip_cli_port.val() + newline +
                            ntrip_cli_user.val() + newline +
                            ntrip_cli_pwd.val() + newline +
                            ntrip_cli_mnt.val() + newline
                    });
                }
            })

            gnss_mode_set_rover.click(function () {
                if (confirm("Start system in Rover mode?")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "gnss_mode_set_rover" + newline
                    });
                }
            });

            gnss_base_fixed_enable.click(function () {
                if (this.checked) {
                    gnss_pane_survey.addClass("d-none");
                    gnss_pane_fixed.removeClass("d-none");
                } else {
                    gnss_pane_survey.removeClass("d-none");
                    gnss_pane_fixed.addClass("d-none");
                }
            })

            gnss_mode_set_survey.click(function () {
                if (confirm("Start system in Base-Survey mode?")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "gnss_mode_set_survey" + newline +
                            gnss_survey_dur.val() + newline +
                            gnss_survey_acc.val() + newline
                    });
                }
            });

            gnss_mode_set_fixed.click(function () {
                if (confirm("Start system in Based-Fixed mode?")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "gnss_mode_set_fixed" + newline +
                            gnss_fixed_lat.val() + newline +
                            gnss_fixed_lon.val() + newline +
                            gnss_fixed_alt.val() + newline
                    });
                }
            })

            // WiFi settings
            let wifi_status = form.find("#wifi_status");
            let wifi_ssid = form.find("#wifi_ssid");
            let wifi_pwd = form.find("#wifi_pwd");
            let wifi_connect = form.find("#wifi_connect");

            wifi_connect.click(function () {
                if (confirm("Connect to a WiFi network?\nReconnect to device after few minutes!")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "wifi_connect" + newline +
                            wifi_ssid.val() + newline +
                            wifi_pwd.val() + newline
                    });
                }
            });

            // Get status
            const STATUS = {
                GNSS_STATUS: 0,
                GNSS_MODE: 1,
                WIFI_STATUS: 2,
            }

            function nmea2dec(nmea, dir) {
                let dot = nmea.indexOf(".");
                let dd = 0;
                let mm = 0.0;

                if (dot > 2) {
                    dd = parseInt(nmea.substring(0, dot - 2));
                    mm = parseFloat(nmea.substring(dot - 2));
                }
                else {
                    mm = parseFloat(nmea);
                }

                let dec = dd + mm / 60;

                if (dir == 'N' || dir == 'E')
                    return dec;
                else
                    return -dec;

            }

            function isIP(text) {
                let parts = text.split(".");
                console.log(parts);
                return parts.length == 4;
            }

            function query_status() {
                $.ajax({
                    url: "/status",
                    type: "GET",
                    contentType: "text/plain",
                    success: function (response, status) {
                        let data = response.split(newline);
                        // ordered items

                        // GNSS Status
                        let gnss_gga = data[STATUS.GNSS_STATUS].split(",");

                        let gnss_status_val = parseInt(gnss_gga[6]);
                        switch (gnss_status_val) {
                            case 0:
                                gnss_status.text("No Fix");
                                break;
                            case 1:
                                gnss_status.text("Single");
                                break;
                            case 2:
                                gnss_status.text("Float");
                                break;
                            case 4:
                                gnss_status.text("RTK Fix");
                                break;
                            case 5:
                                gnss_status.text("RTK Float");
                                break;
                            default:
                                gnss_status.text("Unknown");
                                break;
                        }

                        let gnss_lat_val = nmea2dec(gnss_gga[2], gnss_gga[3]);
                        gnss_lat.val(gnss_lat_val.toFixed(9));

                        let gnss_lon_val = nmea2dec(gnss_gga[4], gnss_gga[5]);
                        gnss_lon.val(gnss_lon_val.toFixed(9));

                        let gnss_alt_val = parseFloat(gnss_gga[9]);
                        gnss_alt.val(gnss_alt_val.toFixed(3));

                        // GNSS Mode
                        let gnss_mode_val = data[STATUS.GNSS_MODE];
                        gnss_mode.val(gnss_mode_val);

                        // WIFI Status
                        let wifi_status_val = data[STATUS.WIFI_STATUS];
                        wifi_status.text(wifi_status_val);
                    }
                });
            }

            let query_status_timer = setInterval(query_status, 1000);

            // System Settings
            let system_hostname = form.find("#system_hostname");
            let system_version = form.find("#system_version");

            let system_status_enable = form.find("#system_status_enable");
            system_status_enable.click(function () {
                if (this.checked) {
                    query_status_timer = setInterval(query_status, 1000);
                } else {
                    clearInterval(query_status_timer);
                }
            });

            let system_save = form.find("#system_save");
            system_save.click(function () {
                if (confirm("Save current settings?")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "system_save" + newline +
                            "dummy" + newline +
                            "dummy" + newline +
                            wifi_ssid.val() + newline +
                            wifi_pwd.val() + newline +
                            ntrip_cli_ip.val() + newline +
                            ntrip_cli_port.val() + newline +
                            ntrip_cli_user.val() + newline +
                            ntrip_cli_pwd.val() + newline +
                            ntrip_cli_mnt.val() + newline +
                            gnss_fixed_lat.val() + newline +
                            gnss_fixed_lon.val() + newline +
                            gnss_fixed_alt.val() + newline
                    });
                }
            });

            let system_restart = form.find("#system_restart");
            system_restart.click(function () {
                if (confirm("Do you want to Restart device?")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "system_restart"
                    });
                }
            });

            let system_advanced_enable = form.find("#system_advanced_enable");
            let system_advanced_pane = form.find("#system_advanced_pane");
            system_advanced_enable.click(function () {
                if (this.checked) {
                    system_advanced_pane.removeClass("d-none");
                } else {
                    system_advanced_pane.addClass("d-none");
                }
            });

            let system_clear_settings = form.find("#system_clear_settings");
            system_clear_settings.click(function () {
                if (confirm("Do you want to clear all saved settings?\nSystem will reset after that.")) {
                    $.ajax({
                        url: "/action",
                        type: "POST",
                        contentType: "text/plain",
                        data: "system_clear_settings"
                    });
                }
            });

            const CONFIG = {
                HOSTNAME: 0,
                VERSION: 1,
                WIFI_SSID: 2,
                WIFI_PWD: 3,
                NTRIP_IP: 4,
                NTRIP_PORT: 5,
                NTRIP_USER: 6,
                NTRIP_PWD: 7,
                NTRIP_MNT: 8,
                BASE_LAT: 9,
                BASE_LON: 10,
                BASE_ALT: 11,
            }

            // Load configs
            $.ajax({
                url: "/config",
                type: "GET",
                contentType: "text/plain",
                success: function (response, status) {
                    let data = response.split(newline);

                    // ordered items
                    system_hostname.text(data[CONFIG.HOSTNAME]);
                    system_version.text(data[CONFIG.VERSION]);

                    wifi_ssid.val(data[CONFIG.WIFI_SSID]);
                    wifi_pwd.val(data[CONFIG.WIFI_PWD]);

                    ntrip_cli_ip.val(data[CONFIG.NTRIP_IP]);
                    ntrip_cli_port.val(data[CONFIG.NTRIP_PORT]);
                    ntrip_cli_user.val(data[CONFIG.NTRIP_USER]);
                    ntrip_cli_pwd.val(data[CONFIG.NTRIP_PWD]);
                    // ntrip_cli_mnt.val(data[CONFIG.NTRIP_IP]);
                    ntrip_cli_mnt.empty();
                    ntrip_cli_mnt.append(new Option(data[CONFIG.NTRIP_MNT], data[CONFIG.NTRIP_MNT]));

                    gnss_fixed_lat.val(data[CONFIG.BASE_LAT]);
                    gnss_fixed_lon.val(data[CONFIG.BASE_LON]);
                    gnss_fixed_alt.val(data[CONFIG.BASE_ALT]);
                }
            });
        });
    </script>
</body>

</html>